// INCLUIMOS LAS LIBRERÍAS
#include <MHZ19.h>          // Sensor CO2                                     
#include <SoftwareSerial.h> // la libreria controla el puerto serial entre el módulo de co2 y el ordenador 
#include <SPI.h>            // Para la conexión de dispositivos
#include <nRF24L01.h>       // Para dar uso soporte al módulo transceptor 
#include <RF24.h>           // Para la interacción con el módulo de radio NRF24L01

//DEFINIMOS LOS PINES
#define RX_PIN 4            //Pines del sensor CO2                                        
#define TX_PIN 2            // Pines del sensor CO2                                        
#define BAUDRATE 9600       //Frecuencia a la que se va a abrir el puerto serial                                    

const int PO = A0; 
float buf[15];
float val; 
float pH;

MHZ19 myMHZ19;              //Definimos el nombre del sensor de co2                                           
SoftwareSerial mySerial(RX_PIN, TX_PIN); //El puerto serial que va a permitir la comunicacion entre 
//el ordenador el sensor de CO2 estará fijando en los pines RX_PIN, TX_PIN

RF24 myRF24(7, 8);         // Se declara el objeto y los pines para la 
                           // comunicación SPI con el módulo NRF24L01
byte address[6] = "00001"; // Dirección de transmisión

// CONFIGURACIÓN
void setup() {

Serial.begin(9600); 
mySerial.begin(BAUDRATE);     // empieza el serial  de comunicación                             
myMHZ19.begin(mySerial);      //inicia el sensor de CO2                           

myMHZ19.autoCalibration();    //Autocalibración del sensor                             

myRF24.begin();
myRF24.openWritingPipe(address);
myRF24.setPALevel(RF24_PA_MIN);
myRF24.stopListening();       // Permite la trasmición de datos

// Configuración del pin analógico para el sensor de pH
pinMode(PO, INPUT); 
}

// BUCLE
void loop() { 
  val = 0;
  for(int i = 0; i < 15; i++) {    // Realizamos 10 lecturas y almacenamos en buf
    // Leemos el valor de pH
    buf[i] = analogRead(PO);       // Convertir la lectura en un valor de pH
    delay(15);
    val += buf[i];
  }

  val /= 15;

  float val_1 = (val/1023)*5;
  float pH = (val_1/5)*14 - 3.37;

  // Mostramos el valor de pH en el monitor serie
  Serial.print("pH: ");
  Serial.println(pH, 2);
  
  // Leemos el valor de CO2
  static int CO2 = 0; //variable CO2=0
  CO2 = myMHZ19.getCO2();   //Para obtener los datos de CO2
  // Mostramos el valor de CO2 en el monitor serie
  Serial.print("CO2 (ppm): "); // Puerto serial del ordenador , para que aparezca el texto
  Serial.println(CO2); // Aparecen las mediciones de CO2 en el puerto serial

  // Enviamos el valor de pH  y CO2 a través de nRF24L01
  myRF24.write(&pH, sizeof(pH));
  myRF24.write(&CO2, sizeof(CO2));

  delay(1000); //Espera un 1 segundo
}
